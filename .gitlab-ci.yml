# StreamSlate GitLab CI/CD Configuration
#
# Required CI/CD Variables (Settings > CI/CD > Variables):
# ─────────────────────────────────────────────────────────
#
# For macOS Code Signing (build:macos job):
#   APPLE_CERTIFICATE          - Base64-encoded .p12 certificate file (or File type variable)
#   APPLE_CERTIFICATE_PASSWORD - Password for the .p12 certificate
#
# For macOS Notarization (optional, recommended for distribution):
#   APPLE_ID                   - Apple ID email for notarization
#   APPLE_ID_PASSWORD          - App-specific password (not Apple ID password)
#   APPLE_TEAM_ID              - Apple Developer Team ID
#
# For Container Registry (docker:build job):
#   Uses built-in GitLab CI variables:
#   - CI_REGISTRY, CI_REGISTRY_USER, CI_REGISTRY_PASSWORD, CI_REGISTRY_IMAGE
#   (Automatically available when Container Registry is enabled)
#
# Runner Requirements:
#   - Linux runner for test:linux job (any GitLab runner)
#   - macOS runner with tag 'macos' for build:macos job
#   - Docker-in-Docker for docker:build job
#

stages:
  - lint
  - test
  - build
  - deploy

variables:
  CARGO_TERM_COLOR: always
  # Use cached dependencies
  npm_config_cache: "$CI_PROJECT_DIR/.npm"
  RUST_BACKTRACE: 1

default:
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .npm/
      - src-tauri/target/
      - ~/.cargo/registry/
      - ~/.cargo/git/

.linux: &linux
  image: rust:latest
  before_script:
    - apt-get update
    - apt-get install -y npm nodejs
    # Install dependencies from files
    - xargs -a requirements/ubuntu-build.txt apt-get install -y
    # Filter out -r lines and comments for dev requirements
    - grep -v '^#' requirements/ubuntu-dev.txt | grep -v '^$' | grep -v '^-r' | xargs apt-get install -y
    - npm ci

lint:linux:
  stage: lint
  <<: *linux
  script:
    # TypeScript, Format, Lint
    - npx tsc --noEmit
    - npm run format:check
    - npm run lint
    - cd src-tauri && cargo fmt --all -- --check
    - cargo clippy --all-targets --all-features -- -D warnings

test:linux:
  stage: test
  <<: *linux
  script:
    # Rust tests
    - cd src-tauri && cargo test
    # Return to root for frontend tests
    - cd ..
    # Start xvfb for headless browser testing (Cypress requires a display)
    - Xvfb :99 -screen 0 1920x1080x24 &
    - export DISPLAY=:99
    # Start dev server in background
    - npm run dev &
    - export DEV_PID=$!
    # Wait for server to be ready (poll instead of fixed sleep)
    - |
      for i in $(seq 1 30); do
        curl -s http://localhost:1420 > /dev/null && break
        echo "Waiting for dev server... ($i/30)"
        sleep 2
      done
    # Run Cypress E2E tests
    - npm run test:headless
    - kill $DEV_PID || true

build:macos:
  stage: build
  tags:
    - macos
  script:
    - npm ci
    - ./scripts/import-certificate.sh
    - source build.env
    - echo "Signing with identity: $APPLE_SIGNING_IDENTITY"
    - npm run tauri:build
  after_script:
    # Cleanup keychain
    - security delete-keychain app-signing.keychain-db || true
  artifacts:
    paths:
      - src-tauri/target/release/bundle/dmg/*.dmg
      - src-tauri/target/release/bundle/macos/*.app
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

docker:build:
  stage: deploy
  image: docker:24.0.7
  services:
    - docker:24.0.7-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - |
      if [ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]; then
        docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:latest
        docker push $CI_REGISTRY_IMAGE:latest
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
