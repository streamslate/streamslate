echo "Running pre-push checks..."

# Run TypeScript type checking
echo "ğŸ“‹ Checking TypeScript types..."
if ! npx tsc --noEmit; then
  echo "âŒ TypeScript type errors found. Please fix them before pushing."
  exit 1
fi

# Run frontend tests
echo "ğŸ§ª Running frontend tests..."
# Check if cypress directory exists and has test files
if [ -d "cypress/e2e" ] && [ "$(find cypress/e2e -name '*.cy.ts' -o -name '*.cy.js' | wc -l)" -gt 0 ]; then
  # Check if dev server is running
  if curl -s -o /dev/null -w "%{http_code}" http://localhost:1420 | grep -q "200\|301\|302"; then
    # Function to fix Cypress if it's broken
    fix_cypress() {
      echo "ğŸ”§ Detected Cypress installation issue. Attempting automatic fix..."
      echo "   Clearing Cypress cache..."
      npx cypress cache clear > /dev/null 2>&1
      echo "   Reinstalling Cypress..."
      npx cypress install > /dev/null 2>&1
      echo "âœ… Cypress fix completed. Retrying tests..."
    }
    
    # Try running tests, fix Cypress if it fails with installation issues
    if ! npm run test:headless 2>&1; then
      # Check if the error is related to Cypress installation
      if npm run test:headless 2>&1 | grep -q "Cannot find module\|ENOENT\|cypress.*not found\|installation"; then
        fix_cypress
        # Retry tests after fix
        if ! npm run test:headless; then
          echo "âŒ Frontend tests still failing after Cypress fix. Please check manually."
          exit 1
        fi
      else
        echo "âŒ Frontend tests failed. Please fix them before pushing."
        exit 1
      fi
    fi
  else
    echo "âš ï¸  Dev server not running at http://localhost:1420. Skipping Cypress E2E tests..."
    echo "   To run E2E tests, start the dev server with: npm run tauri:dev"
  fi
else
  echo "âš ï¸  No Cypress tests found. Skipping frontend tests..."
fi

# Run Rust tests if any Rust files are in the commit
if git diff --name-only HEAD @{u} 2>/dev/null | grep -q '\.rs$' || [ $? -eq 128 ]; then
  echo "ğŸ¦€ Running Rust tests..."
  cd src-tauri
  
  if ! cargo test --quiet; then
    echo "âŒ Rust tests failed. Please fix them before pushing."
    exit 1
  fi
  
  cd ..
fi

echo "âœ… All pre-push checks passed! Pushing to remote..."