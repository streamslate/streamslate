echo "Running pre-push checks..."

# Run TypeScript type checking
echo "📋 Checking TypeScript types..."
if ! npx tsc --noEmit; then
  echo "❌ TypeScript type errors found. Please fix them before pushing."
  exit 1
fi

# Run frontend tests
echo "🧪 Running frontend tests..."
# Check if cypress directory exists and has test files
if [ -d "cypress/e2e" ] && [ "$(find cypress/e2e -name '*.cy.ts' -o -name '*.cy.js' | wc -l)" -gt 0 ]; then
  if ! npm run test:headless; then
    echo "❌ Frontend tests failed. Please fix them before pushing."
    exit 1
  fi
else
  echo "⚠️  No Cypress tests found. Skipping frontend tests..."
fi

# Run Rust tests if any Rust files are in the commit
if git diff --name-only HEAD @{u} 2>/dev/null | grep -q '\.rs$' || [ $? -eq 128 ]; then
  echo "🦀 Running Rust tests..."
  cd src-tauri
  
  if ! cargo test --quiet; then
    echo "❌ Rust tests failed. Please fix them before pushing."
    exit 1
  fi
  
  cd ..
fi

echo "✅ All pre-push checks passed! Pushing to remote..."